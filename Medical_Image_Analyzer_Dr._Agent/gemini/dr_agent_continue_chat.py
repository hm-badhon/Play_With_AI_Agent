import os
import uuid
from PIL import Image as PILImage
import streamlit as st
from agno.agent import Agent
from agno.models.google import Gemini
from agno.tools.duckduckgo import DuckDuckGoTools
from agno.media import Image as AgnoImage

# тЬЕ Must be the first Streamlit command
st.set_page_config(page_title="ЁЯй║ NAD - ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг", layout="centered")

# Set API Key
os.environ["GOOGLE_API_KEY"] = "AIzaSyCQVrag8PvuNMYY5RGLdlAnSBap9_2_3DY"

# Load Queries
# Ophthalmology (Eye Doctor) Query in Bengali
ophthalmology_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЪржХрзНрж╖рзБ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржпрж┐ржирж┐ рж░рзЗржЯрж┐ржирж╛рж▓ ржЗржорзЗржЬрж┐ржВ ржПржмржВ ржЪрзЛржЦрзЗрж░ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝рзЗ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (рж░рзЗржЯрж┐ржирж╛рж▓ ржлржЯрзЛржЧрзНрж░рж╛ржлрж┐, OCT, ржлрж╛ржирзНржбрж╛рж╕ ржЗржорзЗржЬ ржЗрждрзНржпрж╛ржжрж┐)ред
- ржХрзЛржи ржЪрзЛржЦрзЗрж░ ржЕржЮрзНржЪрж▓ (рж░рзЗржЯрж┐ржирж╛, ржЕржкржЯрж┐ржХ ржбрж┐рж╕рзНржХ, ржорзНржпрж╛ржХрзБрж▓рж╛ ржЗрждрзНржпрж╛ржжрж┐) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рж╕рзБржирж┐рж░рзНржжрж┐рж╖рзНржЯржнрж╛ржмрзЗ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи рж░рзЗржЯрж┐ржирж╛рж░ ржЕржмрж╕рзНржерж╛, рж░ржХрзНрждржирж╛рж▓рзАрж░ ржЧржаржи)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи ржбрж╛ржпрж╝рж╛ржмрзЗржЯрж┐ржХ рж░рзЗржЯрж┐ржирзЛржкрзНржпрж╛ржерж┐, ржорзНржпрж╛ржХрзБрж▓рж╛рж░ ржбрж┐ржЬрзЗржирж╛рж░рзЗрж╢ржи)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржорзНржпрж╛ржХрзБрж▓рж╛рж░ ржкрзБрж░рзБрждрзНржм) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### рзй. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧрж╕ржорзВрж╣ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж╛ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржжрзГрж╖рзНржЯрж┐рж╣рж╛ржирж┐рж░ ржЭрзБржБржХрж┐) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржорзНржпрж╛ржХрзБрж▓рж╛, рж░рзЗржЯрж┐ржирзЛржкрзНржпрж╛ржерж┐) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЬрзАржмржирзЗрж░ ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Cardiology Doctor Query in Bengali
cardiology_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржХрж╛рж░рзНржбрж┐ржУрж▓ржЬрж┐рж╕рзНржЯ, ржпрж┐ржирж┐ рж╣рзГржжрж░рзЛржЧ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЗржорзЗржЬрж┐ржВ (ржпрзЗржоржи ржЗржХрзЛржХрж╛рж░рзНржбрж┐ржУржЧрзНрж░рж╛ржо, ржПржиржЬрж┐ржУржЧрзНрж░рж╛ржо) ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (ржЗржХрзЛржХрж╛рж░рзНржбрж┐ржУржЧрзНрж░рж╛ржо, ржХрж╛рж░рзНржбрж┐ржпрж╝рж╛ржХ CT, ржПржиржЬрж┐ржУржЧрзНрж░рж╛ржо ржЗрждрзНржпрж╛ржжрж┐)ред
- рж╣рзГржжржкрж┐ржгрзНржбрзЗрж░ ржХрзЛржи ржЕржЮрзНржЪрж▓ (ржнрж╛рж▓рзНржн, ржнрзЗржирзНржЯрзНрж░рж┐ржХрж▓, ржХрж░рзЛржирж╛рж░рж┐ ржзржоржирзА) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи ржнрж╛рж▓рзНржнрзЗрж░ ржХрж╛рж░рзНржпржХрж╛рж░рж┐рждрж╛, ржзржоржирзАрж░ рж╕ржВржХрзАрж░рзНржгрждрж╛)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи рж╕рзНржЯрзЗржирзЛрж╕рж┐рж╕, ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи, ржзржоржирзАрж░ ржмрзНржпрж╛рж╕) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### рзй. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи рждрзАржмрзНрж░ ржХрж░рзЛржирж╛рж░рж┐ рж╕рж┐ржиржбрзНрж░рзЛржо) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи, рж╕рзНржЯрзЗржирзЛрж╕рж┐рж╕) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Orthopedics Specialist Query in Bengali
orthopedics_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЕрж░рзНржерзЛржкрзЗржбрж┐ржХ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржпрж┐ржирж┐ рж╣рж╛ржбрж╝ ржПржмржВ ржЬржпрж╝рзЗржирзНржЯ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЗржорзЗржЬрж┐ржВ (ржпрзЗржоржи ржПржХрзНрж╕-рж░рзЗ, MRI, CT рж╕рзНржХрзНржпрж╛ржи) ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗ ржжржХрзНрж╖ред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (ржПржХрзНрж╕-рж░рзЗ, MRI, CT рж╕рзНржХрзНржпрж╛ржи ржЗрждрзНржпрж╛ржжрж┐)ред
- ржХрзЛржи рж╢рж╛рж░рзАрж░рж┐ржХ ржЕржЮрзНржЪрж▓ (рж╣рж╛ржбрж╝, ржЬржпрж╝рзЗржирзНржЯ, ржорзЗрж░рзБржжржгрзНржб, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░ рж╕рж╛ржЗржЯ) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи рж╣рж╛ржбрж╝рзЗрж░ ржЧржаржи, ржЬржпрж╝рзЗржирзНржЯрзЗрж░ рж╕рзНржерж╛ржи, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ ржзрж░ржи)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░, ржЕрж╕рзНржЯрж┐ржУржЖрж░рзНржерзНрж░рж╛ржЗржЯрж┐рж╕, ржбрж┐рж╕рж▓рзЛржХрзЗрж╢ржи)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржЬржпрж╝рзЗржирзНржЯ рж╕рзНржкрзЗрж╕ ржкрзНрж░рж╕рзНрже, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ ржжрзИрж░рзНржШрзНржп) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### я┐╜я╝У. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ рж╕рзНржерж╛ржиржЪрзНржпрзБрждрж┐, рж╕ржВржХрзНрж░ржоржгрзЗрж░ ржЭрзБржБржХрж┐) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░, ржЕрж╕рзНржЯрж┐ржУржЖрж░рзНржерзНрж░рж╛ржЗржЯрж┐рж╕) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Medicine Doctor (Last Opinion) Query in Bengali
medicine_last_opinion_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЗржирзНржЯрж╛рж░ржирж╛рж▓ ржорзЗржбрж┐рж╕рж┐ржи ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ рж░рзЛржЧрзАрж░ рж╕ржорж╕рзНржпрж╛рж░ рж╕рж╛ржерзЗ рж╕ржорзНржкрж░рзНржХрж┐ржд ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮржжрзЗрж░ (ржЪржХрзНрж╖рзБ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржХрж╛рж░рзНржбрж┐ржУрж▓ржЬрж┐рж╕рзНржЯ, ржЕрж░рзНржерзЛржкрзЗржбрж┐ржХ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред рж╢рзБржзрзБржорж╛рждрзНрж░ рж╕ржорзНржкрж░рзНржХрж┐ржд ржмрж┐рж╢рзЗрж╖ржЬрзНржЮржжрзЗрж░ ржирж╛ржо ржПржмржВ рждрж╛ржжрзЗрж░ ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХрждрж╛рж░ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржмрж╛ ржЕржирзНржпрж╛ржирзНржп ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи, ржкрж░рзНржпржмрзЗржХрзНрж╖ржг, рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝, рж░рзЛржЧрзАрж░ ржмрзНржпрж╛ржЦрзНржпрж╛, ржЧржмрзЗрж╖ржгрж╛ рж░рзЗржлрж╛рж░рзЗржирзНрж╕) ржЕржирзНрждрж░рзНржнрзБржХрзНржд ржХрж░ржмрзЗржи ржирж╛ред
"""

# Initialize Agents
ophthalmology_agent = Agent(model=Gemini(id="gemini-2.0-flash-exp"), tools=[DuckDuckGoTools()], markdown=True)
cardiology_agent = Agent(model=Gemini(id="gemini-2.0-flash-exp"), tools=[DuckDuckGoTools()], markdown=True)
orthopedics_agent = Agent(model=Gemini(id="gemini-2.0-flash-exp"), tools=[DuckDuckGoTools()], markdown=True)
medicine_last_opinion_agent = Agent(model=Gemini(id="gemini-2.0-flash-exp"), tools=[DuckDuckGoTools()], markdown=True)

agent_options = {
    "Eye Doctor": (ophthalmology_agent, "Ophthalmology Analysis", ophthalmology_query),
    "Cardiology Doctor": (cardiology_agent, "Cardiology Analysis", cardiology_query),
    "Orthopedics Specialist": (orthopedics_agent, "Orthopedics Analysis", orthopedics_query),
    "Medicine Doctor (Last Opinion)": (medicine_last_opinion_agent, "Last Opinion Analysis", medicine_last_opinion_query)
}

# Initial Greeting
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []
    st.session_state.chat_history.append({"role": "doctor", "text": "ЁЯСЛ рж╕рзНржмрж╛ржЧрждржо! ржЖржорж┐ ржПржХржЬржи ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржХред ржПржХржЯрж┐ ржЗржорзЗржЬ ржЖржкрж▓рзЛржб ржХрж░рзБржи ржПржмржВ ржпрзЗржХрзЛржирзЛ ржкрзНрж░рж╢рзНржи ржХрж░рзБржиред"})

# UI Title
st.markdown("""
    <div style='text-align: center;'>
        <h1 style='color:#2563EB;'>ЁЯй║ NAD - ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг</h1>
        <p style='font-size:18px;'>AI ржжрзНржмрж╛рж░рж╛ ржЪрж╛рж▓рж┐ржд ржПржХржЯрж┐ рж╕рзНржорж╛рж░рзНржЯ ржЪрж┐ржХрж┐рзОрж╕рж╛ рж╕рж╣ржХрж╛рж░рзА</p>
    </div>
""", unsafe_allow_html=True)

# File Upload
uploaded_file = st.file_uploader("ЁЯСЗ ржПржЦрж╛ржирзЗ ржЖржкржирж╛рж░ ржЗржорзЗржЬ ржлрж╛ржЗрж▓ ржЯрзЗржирзЗ ржЖржирзБржи ржмрж╛ ржХрзНрж▓рж┐ржХ ржХрж░рзБржи", type=["jpg", "jpeg", "png", "bmp", "gif"])

# Agent Selection
selected_agent_names = st.multiselect(
    "ЁЯСитАНтЪХя╕П ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗрж░ ржЬржирзНржп ржбрж╛ржХрзНрждрж╛рж░ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи",
    options=list(agent_options.keys()),
    default=["Eye Doctor"]
)

# Report Display
def display_report_card(title, content):
    st.markdown(f"""
    <div style="background-color: #f0f2f6; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h4>{title}</h4>
        <div>{content}</div>
    </div>
    """, unsafe_allow_html=True)

# Image Analysis Logic
def analyze_medical_image(image_path, selected_agents):
    image = PILImage.open(image_path)
    aspect_ratio = image.width / image.height
    resized_image = image.resize((500, int(500 / aspect_ratio)))
    temp_path = f"temp_resized_{uuid.uuid4()}.png"
    resized_image.save(temp_path)
    agno_image = AgnoImage(filepath=temp_path)

    reports = {}
    try:
        for agent, agent_name, query_text in selected_agents:
            response = agent.run(query_text, images=[agno_image])
            reports[agent_name] = response.content
    except Exception as e:
        reports["Error"] = f"тЪая╕П ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рждрзНрж░рзБржЯрж┐: {e}"
    finally:
        if os.path.exists(temp_path):
            os.remove(temp_path)
    return reports

# Show Uploaded Image & Analyze
if uploaded_file is not None:
    st.image(uploaded_file, caption="ржЖржкрж▓рзЛржб ржХрж░рж╛ ржЗржорзЗржЬ", use_container_width=True)

    if st.button("ЁЯФН ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╢рзБрж░рзБ ржХрж░рзБржи"):
        if not selected_agent_names:
            st.error("тЪая╕П ржЕржирзНрждржд ржПржХржЯрж┐ ржбрж╛ржХрзНрждрж╛рж░ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржиред")
        else:
            with st.spinner("ЁЯФм AI ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржЪрж▓ржЫрзЗ..."):
                image_ext = uploaded_file.type.split("/")[1]
                image_path = f"temp_input_{uuid.uuid4()}.{image_ext}"
                with open(image_path, "wb") as f:
                    f.write(uploaded_file.getbuffer())

                selected_agents = [agent_options[name] for name in selected_agent_names]
                reports = analyze_medical_image(image_path, selected_agents)

                tabs = st.tabs([name for name in selected_agent_names])
                for i, name in enumerate(selected_agent_names):
                    with tabs[i]:
                        content = reports.get(agent_options[name][1], "тЭМ ржХрзЛржирзЛ рждржерзНржп ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐")
                        display_report_card(agent_options[name][1], content)

                os.remove(image_path)
else:
    st.warning("тЪая╕П ржжржпрж╝рж╛ ржХрж░рзЗ ржПржХржЯрж┐ ржЗржорзЗржЬ ржЖржкрж▓рзЛржб ржХрж░рзБржиред")

# Chat Interface
st.markdown("## ЁЯТм ржЖрж▓рж╛ржкржЪрж╛рж░рж┐рждрж╛")

# Display Chat History
for chat in st.session_state.chat_history:
    if chat["role"] == "user":
        st.markdown(f"<div style='text-align: right; background-color:#DCF8C6; padding:10px; border-radius:10px; margin:5px 0;'>{chat['text']}</div>", unsafe_allow_html=True)
    else:
        st.markdown(f"<div style='text-align: left; background-color:#F0F2F6; padding:10px; border-radius:10px; margin:5px 0;'>{chat['text']}</div>", unsafe_allow_html=True)

# Input for Chat
st.markdown("---")
st.markdown("#### ржирждрзБржи ржкрзНрж░рж╢рзНржи ржХрж░рзБржи")
chat_col1, chat_col2 = st.columns([4, 1])

with chat_col1:
    user_input = st.text_input("тЬНя╕П", placeholder="ржЖржкржирж╛рж░ ржкрзНрж░рж╢рзНржи рж▓рж┐ржЦрзБржи", label_visibility="collapsed", key="chat_input")
with chat_col2:
    selected_doctor = st.selectbox("ржбрж╛ржХрзНрждрж╛рж░", options=list(agent_options.keys()), label_visibility="collapsed", index=0)

if st.button("ЁЯУи ржкрж╛ржарж╛ржи"):
    if user_input.strip():
        st.session_state.chat_history.append({"role": "user", "text": user_input})
        selected_agent = agent_options[selected_doctor][0]
        response = selected_agent.run(user_input)
        st.session_state.chat_history.append({"role": "doctor", "text": response.content})
    else:
        st.warning("тЪая╕П ржкрзНрж░рж╢рзНржи рж▓рж┐ржЦрзБржиред")
