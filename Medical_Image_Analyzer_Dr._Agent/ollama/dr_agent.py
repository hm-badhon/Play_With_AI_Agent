import os
import uuid
import base64
import requests
from PIL import Image as PILImage
import streamlit as st

# -----------------------------------------
# Local Ollama LLM Client
# -----------------------------------------
class OllamaLLM:
    def __init__(self, model_name="llava"):
        self.model_name = model_name
        self.endpoint = "http://localhost:11434/api/generate"

    def _encode_image(self, image_path):
        with open(image_path, "rb") as image_file:
            return base64.b64encode(image_file.read()).decode("utf-8")

    def generate(self, prompt, image_path):
        encoded_image = self._encode_image(image_path)
        payload = {
            "model": self.model_name,
            "prompt": prompt,
            "images": [encoded_image],
            "stream": False,
        }
        response = requests.post(self.endpoint, json=payload)
        if response.ok:
            return response.json().get("response", "")
        else:
            raise Exception(f"Ollama Error: {response.text}")

# -----------------------------------------
# Bengali Medical Prompts
# -----------------------------------------
# Ophthalmology (Eye Doctor) Query in Bengali
ophthalmology_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЪржХрзНрж╖рзБ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржпрж┐ржирж┐ рж░рзЗржЯрж┐ржирж╛рж▓ ржЗржорзЗржЬрж┐ржВ ржПржмржВ ржЪрзЛржЦрзЗрж░ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝рзЗ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (рж░рзЗржЯрж┐ржирж╛рж▓ ржлржЯрзЛржЧрзНрж░рж╛ржлрж┐, OCT, ржлрж╛ржирзНржбрж╛рж╕ ржЗржорзЗржЬ ржЗрждрзНржпрж╛ржжрж┐)ред
- ржХрзЛржи ржЪрзЛржЦрзЗрж░ ржЕржЮрзНржЪрж▓ (рж░рзЗржЯрж┐ржирж╛, ржЕржкржЯрж┐ржХ ржбрж┐рж╕рзНржХ, ржорзНржпрж╛ржХрзБрж▓рж╛ ржЗрждрзНржпрж╛ржжрж┐) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рж╕рзБржирж┐рж░рзНржжрж┐рж╖рзНржЯржнрж╛ржмрзЗ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи рж░рзЗржЯрж┐ржирж╛рж░ ржЕржмрж╕рзНржерж╛, рж░ржХрзНрждржирж╛рж▓рзАрж░ ржЧржаржи)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи ржбрж╛ржпрж╝рж╛ржмрзЗржЯрж┐ржХ рж░рзЗржЯрж┐ржирзЛржкрзНржпрж╛ржерж┐, ржорзНржпрж╛ржХрзБрж▓рж╛рж░ ржбрж┐ржЬрзЗржирж╛рж░рзЗрж╢ржи)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржорзНржпрж╛ржХрзБрж▓рж╛рж░ ржкрзБрж░рзБрждрзНржм) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### рзй. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧрж╕ржорзВрж╣ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж╛ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржжрзГрж╖рзНржЯрж┐рж╣рж╛ржирж┐рж░ ржЭрзБржБржХрж┐) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржорзНржпрж╛ржХрзБрж▓рж╛, рж░рзЗржЯрж┐ржирзЛржкрзНржпрж╛ржерж┐) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЬрзАржмржирзЗрж░ ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Cardiology Doctor Query in Bengali
cardiology_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржХрж╛рж░рзНржбрж┐ржУрж▓ржЬрж┐рж╕рзНржЯ, ржпрж┐ржирж┐ рж╣рзГржжрж░рзЛржЧ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЗржорзЗржЬрж┐ржВ (ржпрзЗржоржи ржЗржХрзЛржХрж╛рж░рзНржбрж┐ржУржЧрзНрж░рж╛ржо, ржПржиржЬрж┐ржУржЧрзНрж░рж╛ржо) ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (ржЗржХрзЛржХрж╛рж░рзНржбрж┐ржУржЧрзНрж░рж╛ржо, ржХрж╛рж░рзНржбрж┐ржпрж╝рж╛ржХ CT, ржПржиржЬрж┐ржУржЧрзНрж░рж╛ржо ржЗрждрзНржпрж╛ржжрж┐)ред
- рж╣рзГржжржкрж┐ржгрзНржбрзЗрж░ ржХрзЛржи ржЕржЮрзНржЪрж▓ (ржнрж╛рж▓рзНржн, ржнрзЗржирзНржЯрзНрж░рж┐ржХрж▓, ржХрж░рзЛржирж╛рж░рж┐ ржзржоржирзА) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи ржнрж╛рж▓рзНржнрзЗрж░ ржХрж╛рж░рзНржпржХрж╛рж░рж┐рждрж╛, ржзржоржирзАрж░ рж╕ржВржХрзАрж░рзНржгрждрж╛)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи рж╕рзНржЯрзЗржирзЛрж╕рж┐рж╕, ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи, ржзржоржирзАрж░ ржмрзНржпрж╛рж╕) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### рзй. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи рждрзАржмрзНрж░ ржХрж░рзЛржирж╛рж░рж┐ рж╕рж┐ржиржбрзНрж░рзЛржо) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи, рж╕рзНржЯрзЗржирзЛрж╕рж┐рж╕) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Orthopedics Specialist Query in Bengali
orthopedics_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЕрж░рзНржерзЛржкрзЗржбрж┐ржХ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржпрж┐ржирж┐ рж╣рж╛ржбрж╝ ржПржмржВ ржЬржпрж╝рзЗржирзНржЯ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЗржорзЗржЬрж┐ржВ (ржпрзЗржоржи ржПржХрзНрж╕-рж░рзЗ, MRI, CT рж╕рзНржХрзНржпрж╛ржи) ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗ ржжржХрзНрж╖ред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (ржПржХрзНрж╕-рж░рзЗ, MRI, CT рж╕рзНржХрзНржпрж╛ржи ржЗрждрзНржпрж╛ржжрж┐)ред
- ржХрзЛржи рж╢рж╛рж░рзАрж░рж┐ржХ ржЕржЮрзНржЪрж▓ (рж╣рж╛ржбрж╝, ржЬржпрж╝рзЗржирзНржЯ, ржорзЗрж░рзБржжржгрзНржб, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░ рж╕рж╛ржЗржЯ) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи рж╣рж╛ржбрж╝рзЗрж░ ржЧржаржи, ржЬржпрж╝рзЗржирзНржЯрзЗрж░ рж╕рзНржерж╛ржи, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ ржзрж░ржи)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░, ржЕрж╕рзНржЯрж┐ржУржЖрж░рзНржерзНрж░рж╛ржЗржЯрж┐рж╕, ржбрж┐рж╕рж▓рзЛржХрзЗрж╢ржи)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржЬржпрж╝рзЗржирзНржЯ рж╕рзНржкрзЗрж╕ ржкрзНрж░рж╕рзНрже, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ ржжрзИрж░рзНржШрзНржп) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### я┐╜я╝У. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ рж╕рзНржерж╛ржиржЪрзНржпрзБрждрж┐, рж╕ржВржХрзНрж░ржоржгрзЗрж░ ржЭрзБржБржХрж┐) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░, ржЕрж╕рзНржЯрж┐ржУржЖрж░рзНржерзНрж░рж╛ржЗржЯрж┐рж╕) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Medicine Doctor (Last Opinion) Query in Bengali
medicine_last_opinion_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЗржирзНржЯрж╛рж░ржирж╛рж▓ ржорзЗржбрж┐рж╕рж┐ржи ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ рж░рзЛржЧрзАрж░ рж╕ржорж╕рзНржпрж╛рж░ рж╕рж╛ржерзЗ рж╕ржорзНржкрж░рзНржХрж┐ржд ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮржжрзЗрж░ (ржЪржХрзНрж╖рзБ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржХрж╛рж░рзНржбрж┐ржУрж▓ржЬрж┐рж╕рзНржЯ, ржЕрж░рзНржерзЛржкрзЗржбрж┐ржХ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред рж╢рзБржзрзБржорж╛рждрзНрж░ рж╕ржорзНржкрж░рзНржХрж┐ржд ржмрж┐рж╢рзЗрж╖ржЬрзНржЮржжрзЗрж░ ржирж╛ржо ржПржмржВ рждрж╛ржжрзЗрж░ ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХрждрж╛рж░ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржмрж╛ ржЕржирзНржпрж╛ржирзНржп ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи, ржкрж░рзНржпржмрзЗржХрзНрж╖ржг, рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝, рж░рзЛржЧрзАрж░ ржмрзНржпрж╛ржЦрзНржпрж╛, ржЧржмрзЗрж╖ржгрж╛ рж░рзЗржлрж╛рж░рзЗржирзНрж╕) ржЕржирзНрждрж░рзНржнрзБржХрзНржд ржХрж░ржмрзЗржи ржирж╛ред
"""

# -----------------------------------------
# Ollama Setup and Agent Mapping
# -----------------------------------------
ollama_model = OllamaLLM(model_name="llava")

agent_options = {
    "Eye Doctor": ("Ophthalmology Analysis", ophthalmology_query),
    "Cardiology Doctor": ("Cardiology Analysis", cardiology_query),
    "Orthopedics Specialist": ("Orthopedics Analysis", orthopedics_query),
    "Medicine Doctor (Last Opinion)": ("Last Opinion Analysis", medicine_last_opinion_query)
}

# -----------------------------------------
# Image Analyzer Function
# -----------------------------------------
def analyze_medical_image(image_path, selected_agents):
    image = PILImage.open(image_path)
    width, height = image.size
    aspect_ratio = width / height
    new_width = 500
    new_height = int(new_width / aspect_ratio)
    resized_image = image.resize((new_width, new_height))

    temp_path = f"temp_resized_image_{uuid.uuid4()}.png"
    resized_image.save(temp_path)

    reports = {}
    try:
        for agent_name, query_text in selected_agents:
            response = ollama_model.generate(query_text, temp_path)
            reports[agent_name] = response
    except Exception as e:
        reports["Error"] = f"тЪая╕П ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рждрзНрж░рзБржЯрж┐: {e}"
    finally:
        if os.path.exists(temp_path):
            os.remove(temp_path)
    return reports

# -----------------------------------------
# Streamlit UI Setup
# -----------------------------------------
st.set_page_config(page_title="ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг", layout="centered")
st.title("ЁЯй║ NAD - ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржЯрзБрж▓ ЁЯФм")
st.markdown(
    """
    рж╕рзНржмрж╛ржЧрждржо **Next AI-Assistant Doctor  - NAD ! ** ржЖржорж╛ржжрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржЯрзБрж▓рзЗ! ЁЯУ╕  

    ржПржХржЯрж┐ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ (рж░рзЗржЯрж┐ржирж╛рж▓ рж╕рзНржХрзНржпрж╛ржи, ржЗржХрзЛржХрж╛рж░рзНржбрж┐ржУржЧрзНрж░рж╛ржо, ржПржХрзНрж╕-рж░рзЗ ржЗрждрзНржпрж╛ржжрж┐) ржЖржкрж▓рзЛржб ржХрж░рзБржиред ржЖржорж╛ржжрзЗрж░ AI-ржкрж╛ржУржпрж╝рж╛рж░рзНржб рж╕рж┐рж╕рзНржЯрзЗржо ржЪрж╛рж░ржЬржи ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ (ржЪржХрзНрж╖рзБ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржХрж╛рж░рзНржбрж┐ржУрж▓ржЬрж┐рж╕рзНржЯ, ржЕрж░рзНржерзЛржкрзЗржбрж┐ржХ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ ржПржмржВ ржЗржирзНржЯрж╛рж░ржирж╛рж▓ ржорзЗржбрж┐рж╕рж┐ржи ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ) ржжрзНржмрж╛рж░рж╛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзЗ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд рж░рж┐ржкрзЛрж░рзНржЯ ржжрж┐ржмрзЗред

    ржЪрж▓рзБржи рж╢рзБрж░рзБ ржХрж░рж┐!
    """
)

st.sidebar.header("ржЖржкржирж╛рж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржЖржкрж▓рзЛржб ржХрж░рзБржи:")
uploaded_file = st.sidebar.file_uploader("ржЗржорзЗржЬ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи", type=["jpg", "jpeg", "png", "bmp", "gif"])

st.sidebar.header("ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗрж░ ржЬржирзНржп ржПржЬрзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи:")
selected_agent_names = st.sidebar.multiselect(
    "ржПржЬрзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи",
    options=list(agent_options.keys()),
    default=["Eye Doctor"]
)

if uploaded_file is not None:
    st.image(uploaded_file, caption="ржЖржкрж▓рзЛржб ржХрж░рж╛ ржЗржорзЗржЬ", use_container_width=True)
    if st.sidebar.button("ЁЯФН ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╢рзБрж░рзБ ржХрж░рзБржи"):
        if not selected_agent_names:
            st.error("тЪая╕П ржЕржирзНрждржд ржПржХржЯрж┐ ржПржЬрзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржиред")
        else:
            with st.spinner("ЁЯФН ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржЪрж▓ржЫрзЗ... ржжржпрж╝рж╛ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи....."):
                image_path = f"temp_image_{uuid.uuid4()}.{uploaded_file.type.split('/')[1]}"
                with open(image_path, "wb") as f:
                    f.write(uploaded_file.getbuffer())

                selected_agents = [(name, agent_options[name][1]) for name in selected_agent_names]
                reports = analyze_medical_image(image_path, selected_agents)

                st.subheader("ЁЯУЛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж░рж┐ржкрзЛрж░рзНржЯ")
                for agent_name, report in reports.items():
                    st.markdown(f"### {agent_name}")
                    st.markdown(report, unsafe_allow_html=True)

                if os.path.exists(image_path):
                    os.remove(image_path)
else:
    st.warning("тЪая╕П ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╢рзБрж░рзБрж░ ржЬржирзНржп ржжржпрж╝рж╛ ржХрж░рзЗ ржПржХржЯрж┐ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржЖржкрж▓рзЛржб ржХрж░рзБржиред")
