
import os
import uuid
import logging
from PIL import Image as PILImage
from agno.agent import Agent
from agno.models.google import Gemini
from agno.tools.duckduckgo import DuckDuckGoTools
from agno.media import Image as AgnoImage
import streamlit as st

# Optional: Setup logging for debugging
logging.basicConfig(filename="smarthealth_errors.log", level=logging.ERROR)

# --- API Key Setup ---
GOOGLE_API_KEY = "Your_API_Key"
os.environ["GOOGLE_API_KEY"] = GOOGLE_API_KEY

if not GOOGLE_API_KEY:
    raise ValueError("тЪая╕П ржжржпрж╝рж╛ ржХрж░рзЗ GOOGLE_API_KEY рж╕рзЗржЯ ржХрж░рзБржи")


# Ophthalmology (Eye Doctor) Query in Bengali
ophthalmology_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЪржХрзНрж╖рзБ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржпрж┐ржирж┐ рж░рзЗржЯрж┐ржирж╛рж▓ ржЗржорзЗржЬрж┐ржВ ржПржмржВ ржЪрзЛржЦрзЗрж░ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝рзЗ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (рж░рзЗржЯрж┐ржирж╛рж▓ ржлржЯрзЛржЧрзНрж░рж╛ржлрж┐, OCT, ржлрж╛ржирзНржбрж╛рж╕ ржЗржорзЗржЬ ржЗрждрзНржпрж╛ржжрж┐)ред
- ржХрзЛржи ржЪрзЛржЦрзЗрж░ ржЕржЮрзНржЪрж▓ (рж░рзЗржЯрж┐ржирж╛, ржЕржкржЯрж┐ржХ ржбрж┐рж╕рзНржХ, ржорзНржпрж╛ржХрзБрж▓рж╛ ржЗрждрзНржпрж╛ржжрж┐) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рж╕рзБржирж┐рж░рзНржжрж┐рж╖рзНржЯржнрж╛ржмрзЗ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи рж░рзЗржЯрж┐ржирж╛рж░ ржЕржмрж╕рзНржерж╛, рж░ржХрзНрждржирж╛рж▓рзАрж░ ржЧржаржи)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи ржбрж╛ржпрж╝рж╛ржмрзЗржЯрж┐ржХ рж░рзЗржЯрж┐ржирзЛржкрзНржпрж╛ржерж┐, ржорзНржпрж╛ржХрзБрж▓рж╛рж░ ржбрж┐ржЬрзЗржирж╛рж░рзЗрж╢ржи)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржорзНржпрж╛ржХрзБрж▓рж╛рж░ ржкрзБрж░рзБрждрзНржм) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### рзй. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧрж╕ржорзВрж╣ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж╛ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржжрзГрж╖рзНржЯрж┐рж╣рж╛ржирж┐рж░ ржЭрзБржБржХрж┐) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржорзНржпрж╛ржХрзБрж▓рж╛, рж░рзЗржЯрж┐ржирзЛржкрзНржпрж╛ржерж┐) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЬрзАржмржирзЗрж░ ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Cardiology Doctor Query in Bengali
cardiology_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржХрж╛рж░рзНржбрж┐ржУрж▓ржЬрж┐рж╕рзНржЯ, ржпрж┐ржирж┐ рж╣рзГржжрж░рзЛржЧ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЗржорзЗржЬрж┐ржВ (ржпрзЗржоржи ржЗржХрзЛржХрж╛рж░рзНржбрж┐ржУржЧрзНрж░рж╛ржо, ржПржиржЬрж┐ржУржЧрзНрж░рж╛ржо) ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (ржЗржХрзЛржХрж╛рж░рзНржбрж┐ржУржЧрзНрж░рж╛ржо, ржХрж╛рж░рзНржбрж┐ржпрж╝рж╛ржХ CT, ржПржиржЬрж┐ржУржЧрзНрж░рж╛ржо ржЗрждрзНржпрж╛ржжрж┐)ред
- рж╣рзГржжржкрж┐ржгрзНржбрзЗрж░ ржХрзЛржи ржЕржЮрзНржЪрж▓ (ржнрж╛рж▓рзНржн, ржнрзЗржирзНржЯрзНрж░рж┐ржХрж▓, ржХрж░рзЛржирж╛рж░рж┐ ржзржоржирзА) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи ржнрж╛рж▓рзНржнрзЗрж░ ржХрж╛рж░рзНржпржХрж╛рж░рж┐рждрж╛, ржзржоржирзАрж░ рж╕ржВржХрзАрж░рзНржгрждрж╛)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи рж╕рзНржЯрзЗржирзЛрж╕рж┐рж╕, ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи, ржзржоржирзАрж░ ржмрзНржпрж╛рж╕) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### рзй. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи рждрзАржмрзНрж░ ржХрж░рзЛржирж╛рж░рж┐ рж╕рж┐ржиржбрзНрж░рзЛржо) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржЗржЬрзЗржХрж╢ржи ржлрзНрж░рж╛ржХрж╢ржи, рж╕рзНржЯрзЗржирзЛрж╕рж┐рж╕) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Orthopedics Specialist Query in Bengali
orthopedics_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЕрж░рзНржерзЛржкрзЗржбрж┐ржХ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржпрж┐ржирж┐ рж╣рж╛ржбрж╝ ржПржмржВ ржЬржпрж╝рзЗржирзНржЯ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЗржорзЗржЬрж┐ржВ (ржпрзЗржоржи ржПржХрзНрж╕-рж░рзЗ, MRI, CT рж╕рзНржХрзНржпрж╛ржи) ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗ ржжржХрзНрж╖ред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ ржирж┐ржЪрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

### рзз. ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи ржУ ржЕржЮрзНржЪрж▓
- ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи рж╢ржирж╛ржХрзНржд ржХрж░рзБржи (ржПржХрзНрж╕-рж░рзЗ, MRI, CT рж╕рзНржХрзНржпрж╛ржи ржЗрждрзНржпрж╛ржжрж┐)ред
- ржХрзЛржи рж╢рж╛рж░рзАрж░рж┐ржХ ржЕржЮрзНржЪрж▓ (рж╣рж╛ржбрж╝, ржЬржпрж╝рзЗржирзНржЯ, ржорзЗрж░рзБржжржгрзНржб, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░ рж╕рж╛ржЗржЯ) ржПржмржВ ржкржЬрж┐рж╢ржи рждрж╛ ржмрж▓рзБржиред
- ржЪрж┐рждрзНрж░рзЗрж░ ржЧрзБржгржорж╛ржи ржПржмржВ ржХрж╛рж░рж┐ржЧрж░рж┐ ржорж╛ржи ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред

### рзи. ржорзВрж▓ ржкрж░рзНржпржмрзЗржХрзНрж╖ржг
- ржкрзНрж░ржзрж╛ржи ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ рждрзБрж▓рзЗ ржзрж░рзБржи (ржпрзЗржоржи рж╣рж╛ржбрж╝рзЗрж░ ржЧржаржи, ржЬржпрж╝рзЗржирзНржЯрзЗрж░ рж╕рзНржерж╛ржи, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ ржзрж░ржи)ред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕрж╕рзНржмрж╛ржнрж╛ржмрж┐ржХрждрж╛ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░, ржЕрж╕рзНржЯрж┐ржУржЖрж░рзНржерзНрж░рж╛ржЗржЯрж┐рж╕, ржбрж┐рж╕рж▓рзЛржХрзЗрж╢ржи)ред
- ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж░рж┐ржорж╛ржк (ржпрзЗржоржи ржЬржпрж╝рзЗржирзНржЯ рж╕рзНржкрзЗрж╕ ржкрзНрж░рж╕рзНрже, ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ ржжрзИрж░рзНржШрзНржп) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред

### я┐╜я╝У. рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ржорзВрж▓ржХ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
- рж╕ржорзНржнрж╛ржмрзНржп ржкрзНрж░рж╛ржержорж┐ржХ рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝ ржжрж┐ржи ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзЗрж░ рж╕рж╛ржерзЗред
- рж╕ржорзНржнрж╛ржмрзНржп ржЕржирзНржпрж╛ржирзНржп рж░рзЛржЧ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржХрж░рзБржиред
- ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржгржпрж╝рзЗрж░ ржЬржирзНржп ржкрж░рзНржпржмрзЗржХрзНрж╖ржгрзЗрж░ ржнрж┐рждрзНрждрж┐рждрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред
- ржЬрж░рзБрж░рж┐ ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░рзЗрж░ рж╕рзНржерж╛ржиржЪрзНржпрзБрждрж┐, рж╕ржВржХрзНрж░ржоржгрзЗрж░ ржЭрзБржБржХрж┐) рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржХрж░рзБржиред

### рзк. рж░рзЛржЧрзАрж░ ржЬржирзНржп рж╕рж╣ржЬ ржмрзНржпрж╛ржЦрзНржпрж╛
- ржлрж▓рж╛ржлрж▓ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
- ржЪрж┐ржХрж┐рзОрж╕рж╛ржЧржд рж╢ржмрзНржж (ржпрзЗржоржи ржлрзНрж░рзНржпрж╛ржХржЪрж╛рж░, ржЕрж╕рзНржЯрж┐ржУржЖрж░рзНржерзНрж░рж╛ржЗржЯрж┐рж╕) рж╕рж╣ржЬ ржХрж░рзЗ ржмрзЛржЭрж╛ржиред
- ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

### рзл. ржЧржмрзЗрж╖ржгрж╛ ржкрзНрж░рж╕ржЩрзНржЧ
- ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорж░рзНржержирзЗ рзи-рзйржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржжрж┐ржиред In English
"""

# Medicine Doctor (Last Opinion) Query in Bengali
medicine_last_opinion_query = """
**ржЖржкржирж╛рж░ рж╕ржорж╕рзНржд ржЙрждрзНрждрж░ ржмрж╛ржВрж▓рж╛ржпрж╝ ржжрж┐ржиред**

ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ ржЗржирзНржЯрж╛рж░ржирж╛рж▓ ржорзЗржбрж┐рж╕рж┐ржи ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред ржирж┐ржЪрзЗрж░ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзБржи ржПржмржВ рж░рзЛржЧрзАрж░ рж╕ржорж╕рзНржпрж╛рж░ рж╕рж╛ржерзЗ рж╕ржорзНржкрж░рзНржХрж┐ржд ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮржжрзЗрж░ (ржЪржХрзНрж╖рзБ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ, ржХрж╛рж░рзНржбрж┐ржУрж▓ржЬрж┐рж╕рзНржЯ, ржЕрж░рзНржерзЛржкрзЗржбрж┐ржХ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ) ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред рж╢рзБржзрзБржорж╛рждрзНрж░ рж╕ржорзНржкрж░рзНржХрж┐ржд ржмрж┐рж╢рзЗрж╖ржЬрзНржЮржжрзЗрж░ ржирж╛ржо ржПржмржВ рждрж╛ржжрзЗрж░ ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХрждрж╛рж░ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж┐ржиред ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржмрж╛ ржЕржирзНржпрж╛ржирзНржп ржмрж┐рж╖ржпрж╝ (ржпрзЗржоржи ржЪрж┐рждрзНрж░рзЗрж░ ржзрж░ржи, ржкрж░рзНржпржмрзЗржХрзНрж╖ржг, рж░рзЛржЧ ржирж┐рж░рзНржгржпрж╝, рж░рзЛржЧрзАрж░ ржмрзНржпрж╛ржЦрзНржпрж╛, ржЧржмрзЗрж╖ржгрж╛ рж░рзЗржлрж╛рж░рзЗржирзНрж╕) ржЕржирзНрждрж░рзНржнрзБржХрзНржд ржХрж░ржмрзЗржи ржирж╛ред
"""



# --- Agents Initialization ---
ophthalmology_agent = Agent(
    model=Gemini(id="gemini-2.0-flash-exp"),
    tools=[DuckDuckGoTools()],
    markdown=True,
    name="Eye Doctor"
)

cardiology_agent = Agent(
    model=Gemini(id="gemini-2.0-flash-exp"),
    tools=[DuckDuckGoTools()],
    markdown=True,
    name="Cardiology Doctor"
)

orthopedics_agent = Agent(
    model=Gemini(id="gemini-2.0-flash-exp"),
    tools=[DuckDuckGoTools()],
    markdown=True,
    name="Orthopedics Specialist"
)

medicine_last_opinion_agent = Agent(
    model=Gemini(id="gemini-2.0-flash-exp"),
    tools=[DuckDuckGoTools()],
    markdown=True,
    name="Medicine Doctor (Last Opinion)"
)

# --- Image Analysis Function ---
def analyze_medical_image(image_path, selected_agents):
    reports = {}

    try:
        image = PILImage.open(image_path)
    except Exception as e:
        error_msg = f"тЪая╕П ржЗржорзЗржЬ ржЦрзЛрж▓рж╛ ржпрж╛ржпрж╝ржирж┐: {e}"
        logging.error(error_msg, exc_info=True)
        reports["Error"] = error_msg
        return reports

    try:
        width, height = image.size
        new_width = 500
        new_height = int(new_width * height / width)
        resized_image = image.resize((new_width, new_height))
        temp_path = f"temp_resized_image_{uuid.uuid4()}.png"
        resized_image.save(temp_path)
    except Exception as e:
        error_msg = f"тЪая╕П ржЗржорзЗржЬ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗ: {e}"
        logging.error(error_msg, exc_info=True)
        reports["Error"] = error_msg
        return reports

    agno_image = AgnoImage(filepath=temp_path)

    for agent, agent_name, query_text in selected_agents:
        try:
            response = agent.run(query_text, images=[agno_image])
            reports[agent_name] = response.content
        except Exception as e:
            error_msg = f"тЭМ {agent_name} ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗ рждрзНрж░рзБржЯрж┐: {e}"
            logging.error(error_msg, exc_info=True)
            reports[agent_name] = error_msg

    try:
        if os.path.exists(temp_path):
            os.remove(temp_path)
    except Exception as e:
        st.warning(f"тЪая╕П ржЕрж╕рзНржерж╛ржпрж╝рзА ржлрж╛ржЗрж▓ ржорзБржЫрзЗ ржлрзЗрж▓рж╛рж░ рж╕ржоржпрж╝ рждрзНрж░рзБржЯрж┐: {e}")
        logging.warning(f"File cleanup failed: {e}", exc_info=True)

    return reports

# --- Streamlit UI Setup ---
st.set_page_config(page_title="SmartHealth Agent - ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг", layout="centered")

st.title("ЁЯза SmartHealth Agent")
st.markdown("""
рж╕рзНржмрж╛ржЧрждржо **SmartHealth Agent**-ржП!  
ржПржЯрж┐ ржПржХржЯрж┐ ржЖржзрзБржирж┐ржХ AI-ржкрж╛ржУрзЯрж╛рж░рзНржб ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕рж╣ржХрж╛рж░рзА ЁЯй║ЁЯФм

ржЖржкржирж┐ ржПржЦржи:
- ржПржХржЯрж┐ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржЖржкрж▓рзЛржб ржХрж░рждрзЗ ржкрж╛рж░рзЗржи (рж░рзЗржЯрж┐ржирж╛, рж╣рж╛рж░рзНржЯ, рж╣рж╛ржбрж╝ ржЗрждрзНржпрж╛ржжрж┐)
- рзкржЯрж┐ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ ржПржЬрзЗржирзНржЯрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржкрзЗрждрзЗ ржкрж╛рж░рзЗржи
""")

# --- Sidebar: Upload & Agent Selection ---
st.sidebar.header("ЁЯЦ╝я╕П ржЗржорзЗржЬ ржЖржкрж▓рзЛржб ржХрж░рзБржи")
uploaded_file = st.sidebar.file_uploader("ржЗржорзЗржЬ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи", type=["jpg", "jpeg", "png", "bmp", "gif"])

st.sidebar.header("ЁЯдЦ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи")
agent_options = {
    "Eye Doctor": (ophthalmology_agent, "Ophthalmology Analysis", ophthalmology_query),
    "Cardiology Doctor": (cardiology_agent, "Cardiology Analysis", cardiology_query),
    "Orthopedics Specialist": (orthopedics_agent, "Orthopedics Analysis", orthopedics_query),
    "Medicine Doctor (Last Opinion)": (medicine_last_opinion_agent, "Last Opinion Analysis", medicine_last_opinion_query)
}
selected_agent_names = st.sidebar.multiselect(
    "ржпрзЗ ржПржЬрзЗржирзНржЯ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░ржмрзЗ:",
    options=list(agent_options.keys()),
    default=["Eye Doctor"]
)

# --- Main Area: Run Analysis ---
if uploaded_file is not None:
    try:
        st.image(uploaded_file, caption="ржЖржкрж▓рзЛржбржХрзГржд ржЗржорзЗржЬ", use_container_width=True)

        if st.sidebar.button("ЁЯЪА ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╢рзБрж░рзБ ржХрж░рзБржи"):
            if not selected_agent_names:
                st.error("тЪая╕П ржЕржирзНрждржд ржПржХржЯрж┐ ржПржЬрзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржиред")
            else:
                with st.spinner("ЁЯФм AI ржжрзНржмрж╛рж░рж╛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржЪрж▓ржЫрзЗ..."):
                    ext = uploaded_file.type.split('/')[-1]
                    image_path = f"temp_image_{uuid.uuid4()}.{ext}"

                    try:
                        with open(image_path, "wb") as f:
                            f.write(uploaded_file.getbuffer())

                        selected_agents = [agent_options[name] for name in selected_agent_names]
                        reports = analyze_medical_image(image_path, selected_agents)

                        st.subheader("ЁЯУЛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж░рж┐ржкрзЛрж░рзНржЯ")
                        for agent_name, report in reports.items():
                            st.markdown(f"### ЁЯФН {agent_name}")
                            st.markdown(report, unsafe_allow_html=True)

                    except Exception as e:
                        error_msg = f"тЪая╕П ржЗржорзЗржЬ рж╕ржВрж░ржХрзНрж╖ржг ржмрж╛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗрж░ рж╕ржоржпрж╝ рждрзНрж░рзБржЯрж┐: {e}"
                        st.error(error_msg)
                        logging.error(error_msg, exc_info=True)

                    finally:
                        if os.path.exists(image_path):
                            try:
                                os.remove(image_path)
                            except Exception as e:
                                st.warning(f"тЪая╕П ржлрж╛ржЗрж▓ ржорзБржЫрждрзЗ ржмрзНржпрж░рзНрже: {e}")
                                logging.warning(f"Failed to remove uploaded image: {e}", exc_info=True)

    except Exception as e:
        st.error(f"тЪая╕П ржЗржорзЗржЬ рж▓рзЛржб ржХрж░рждрзЗ ржмрзНржпрж░рзНрже: {e}")
        logging.error(f"Image display failed: {e}", exc_info=True)
else:
    st.warning("тЪая╕П ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╢рзБрж░рзБрж░ ржЬржирзНржп ржжржпрж╝рж╛ ржХрж░рзЗ ржПржХржЯрж┐ ржорзЗржбрж┐ржХрзЗрж▓ ржЗржорзЗржЬ ржЖржкрж▓рзЛржб ржХрж░рзБржиред")